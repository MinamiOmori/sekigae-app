<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>席替えアプリ 条件設定</title>
<style>
  body { display:flex; margin:0; font-family:sans-serif; height:100vh; }
  .left, .right { flex:1; padding:10px; box-sizing:border-box; overflow-y:auto; }
  .blackboard { background:black; color:white; text-align:center; padding:10px; margin-bottom:10px; width:420px; font-weight:bold; user-select:none; }
  .seats { display:grid; grid-template-columns:repeat(6,70px); grid-gap:5px; width:420px; user-select:none; }
  .seat {
    width:70px; height:70px; background:#e0e0e0; display:flex; align-items:center; justify-content:center;
    border:1px solid #999; cursor:pointer; font-size:18px; font-weight:bold; user-select:none; word-break:break-word; text-align:center; padding:2px;
    transition: background-color 0.3s;
  }
  .seat.disabled { background:#999; color:white; cursor:default; }
  .seat.fixed { background:#ffa07a; cursor:default; }
  .seat.range { background:#add8e6; cursor:default; }
  .seat.range-selected { background:#3399ff; }
  .condition-group { margin-bottom:10px; border:1px solid #ccc; padding:10px; border-radius:8px; background:#f9f9f9; position:relative; }
  .condition-group input { width:80%; padding:5px; margin-top:5px; font-size:14px; }
  .condition-group button { margin-top:5px; padding:5px 10px; background:#87cefa; border:none; border-radius:4px; cursor:pointer; }
  .condition-group button:hover { background:#1e90ff; color:white; }
  .condition-group .delete { position:absolute; top:5px; right:5px; background:#f44336; color:white; border-radius:50%; width:24px; height:24px; padding:0; font-weight:bold; font-size:16px; line-height:24px; text-align:center; cursor:pointer; border:none; }
  .condition-group .delete:hover { background:#d32f2f; }
  button.add-condition { margin:10px 0; padding:8px 15px; font-size:16px; border-radius:6px; background:#4caf50; color:white; border:none; cursor:pointer; }
  button.add-condition:hover { background:#388e3c; }
  .right>div:last-child button { margin-right:10px; padding:8px 15px; font-size:16px; border-radius:6px; cursor:pointer; border:none; }
  .right>div:last-child button:first-child { background:#f0ad4e; color:white; }
  .right>div:last-child button:first-child:hover { background:#ec971f; }
  .right>div:last-child button:last-child { background:#2196f3; color:white; }
  .right>div:last-child button:last-child:hover { background:#1565c0; }

  /* モーダル */
  #rangeModal {
    display:none; position:fixed; top:0; left:0; right:0; bottom:0;
    background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:9999;
  }
  #rangeModalContent {
    background:white; padding:20px; border-radius:8px; max-width:90vw; max-height:90vh; overflow:auto;
    width:500px;
  }
  #modalSeats {
    display:grid; grid-template-columns:repeat(6,70px); grid-gap:5px; user-select:none; margin-top:15px;
  }
  #modalSeats .seat {
    width:70px; height:70px; border:1px solid #999; display:flex; align-items:center; justify-content:center;
    font-weight:bold; font-size:18px; padding:2px; cursor:pointer; user-select:none; word-break:break-word; text-align:center;
    background:#e0e0e0;
  }
  #modalSeats .seat.selected {
    background:#3399ff; color:white;
  }
  #rangeModalClose, #rangeModalSave {
    margin-top:15px; padding:10px 20px; font-size:16px; border:none; border-radius:6px; cursor:pointer;
  }
  #rangeModalClose { background:#f44336; color:white; }
  #rangeModalClose:hover { background:#d32f2f; }
  #rangeModalSave { background:#4caf50; color:white; margin-left:10px;}
  #rangeModalSave:hover { background:#388e3c; }
</style>
</head>
<body>
<!-- パスワード画面 -->
<div id="passwordScreen" style="
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  backdrop-filter: blur(8px); /* ←背景をぼかす */
  background-color: rgba(0,0,0,0.5); /* 半透明の黒背景 */
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
">
  <div style="
    background:#fff;
    color:#333;
    padding:30px 20px;
    border-radius:10px;
    box-shadow:0 4px 15px rgba(0,0,0,0.3);
    text-align:center;
    width:90%;
    max-width:300px;
  ">
    <h2 style="margin-bottom:15px;">パスワードを入力</h2>
    <input type="password" id="passwordInput" style="padding:8px;width:100%;font-size:16px;">
    <button onclick="checkPassword()" style="margin-top:10px;padding:8px 15px;font-size:16px;width:100%;background:#4caf50;color:#fff;border:none;border-radius:4px;cursor:pointer;">送信</button>
    <p id="passwordError" style="color:red;margin-top:8px;display:none;font-size:14px;">パスワードが違います</p>
  </div>
</div>

<script>
  function checkPassword(){
    var pass = document.getElementById('passwordInput').value;
    if(pass === "fuzoku.sekigae"){ // 
      document.getElementById('passwordScreen').style.display = 'none';
    } else {
      document.getElementById('passwordError').style.display = 'block';
    }
  }
</script>

<!-- スマホ/PC選択モーダル -->
<div id="deviceSelectModal" style="
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  backdrop-filter: blur(8px);
  background-color: rgba(0,0,0,0.5);
  z-index:9998;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#fff;
    color:#333;
    padding:30px 20px;
    border-radius:10px;
    box-shadow:0 4px 15px rgba(0,0,0,0.3);
    text-align:center;
    width:90%;
    max-width:300px;
  ">
    <h2 style="margin-bottom:15px;">表示モードを選択</h2>
    <button id="selectMobile" style="margin:10px 0;padding:12px 20px;font-size:18px;width:100%;background:#2196f3;color:#fff;border:none;border-radius:4px;cursor:pointer;">スマホ版</button>
    <button id="selectPC" style="margin:10px 0;padding:12px 20px;font-size:18px;width:100%;background:#4caf50;color:#fff;border:none;border-radius:4px;cursor:pointer;">PC版</button>
  </div>
</div>

<!-- スマホ版CSS（席レイアウト6列×6行のまま、スクロール対応） -->
<style id="mobileStyle" disabled>
  body { flex-direction:column !important; height:auto !important; }
  .left, .right { width:100% !important; padding:5px !important; }
  .blackboard { width:100% !important; font-size:20px !important; }
  /* 席レイアウトはそのまま（6列×6行）、横スクロール対応 */
  .seats, #modalSeats {
    grid-template-columns:repeat(6,70px) !important;
    width:420px !important;
    overflow-x:auto !important;
    margin:0 auto !important;
  }
  .seat, #modalSeats .seat {
    width:70px !important;
    height:48px !important;
    font-size:15px !important;
  }
  .condition-group input, .condition-group button { width:95% !important; font-size:15px !important; }
  textarea#otherNamesInput { font-size:15px !important; height:80px !important; }
  .right>div:last-child button { font-size:15px !important; padding:10px !important; }
  #rangeModalContent { width:95vw !important; }
</style>

<script>
  // パスワード認証後に選択モーダルを表示
  function checkPassword(){
    var pass = document.getElementById('passwordInput').value;
    if(pass === "fuzoku.sekigae"){
      document.getElementById('passwordScreen').style.display = 'none';
      document.getElementById('deviceSelectModal').style.display = 'flex';
    } else {
      document.getElementById('passwordError').style.display = 'block';
    }
  }

  // スマホ版選択でCSS適用
  document.addEventListener('DOMContentLoaded', function(){
    document.getElementById('selectMobile').onclick = function(){
      document.getElementById('deviceSelectModal').style.display = 'none';
      // スマホ版用CSS有効化
      document.getElementById('mobileStyle').removeAttribute('disabled');
    };
    document.getElementById('selectPC').onclick = function(){
      document.getElementById('deviceSelectModal').style.display = 'none';
      // PC版はデフォルトなので何もしない
    };
  });
</script>
  
<div class="left">
  <div class="blackboard">黒板</div>
  <div class="seats" id="seats"></div>
  <p style="font-size:12px; color:#666; user-select:none; margin-top:8px;">※席をダブルクリックすると無効席に切り替わります</p>
</div>
<div class="right">
  <h2>条件設定</h2>
  <div id="rangeConditions"><h3>範囲指定（誰かをいくつかの席の中に入れる）</h3></div>
  <button class="add-condition" onclick="addRangeCondition()">＋範囲指定を追加</button>
  <div id="fixedConditions"><h3>固定席指定（誰かをこの席に固定）</h3></div>
  <button class="add-condition" onclick="addFixedCondition()">＋固定席指定を追加</button>
  <div id="otherNamesSection" style="margin-top:10px;">
    <label>条件設定なし（どこでも良い人）を改行区切りで入力</label><br>
    <textarea id="otherNamesInput" placeholder="例：田中太郎&#10;佐藤花子" style="width:100%; height:100px; font-size:16px;"></textarea>
  </div>
  <div style="margin-top:15px;">
    <button onclick="resetSelection()">選択リセット</button>
    <button onclick="shuffleSeats()">席替えする！</button>
  </div>
</div>

<script>
  // グローバル変数
  const seatsDiv = document.getElementById('seats');
  const rangeConditions = document.getElementById('rangeConditions');
  const fixedConditions = document.getElementById('fixedConditions');
  const otherNamesInput = document.getElementById('otherNamesInput');
  const rangeModal = document.getElementById('rangeModal');
  const modalSeatsDiv = document.getElementById('modalSeats');
  const rangeModalTitle = document.getElementById('rangeModalTitle');
  const rangeModalCloseBtn = document.getElementById('rangeModalClose');
  const rangeModalSaveBtn = document.getElementById('rangeModalSave');

  // 状態管理
  let mode = ''; // 'range-selecting' or 'fixed-selecting' or ''
  let currentRangeName = '';
  let currentRangeSelectedSeats = new Set();

  let fixedSelections = {}; // { seatNumber: name }
  let rangeSelections = {}; // { name: [seatNumbers] }
  let disabledSeats = new Set(); // 無効席

  // メイン席表の座席生成（36席）
  function createMainSeats(){
    seatsDiv.innerHTML = '';
    for(let i=1; i<=36; i++){
      const seat = document.createElement('div');
      seat.className = 'seat';
      seat.textContent = i;
      seat.dataset.number = i;
      if(disabledSeats.has(i)){
        seat.classList.add('disabled');
        seat.textContent = '×';
        seat.style.cursor = 'default';
      }
      else if(fixedSelections[i]){
        seat.classList.add('fixed');
        seat.textContent = fixedSelections[i];
        seat.style.cursor = 'default';
      }
      else{
        let isInRange = false;
        for(const seats of Object.values(rangeSelections)){
          if(seats.includes(i)) {
            isInRange = true;
            break;
          }
        }
        if(isInRange){
          seat.classList.add('range');
        } else {
          seat.classList.remove('range');
        }
        seat.textContent = i;
        seat.style.cursor = 'pointer';
      }
      seatsDiv.appendChild(seat);
    }
  }

  // 範囲指定条件追加
  function addRangeCondition(){
    const div = document.createElement('div');
    div.className = 'condition-group';
    div.innerHTML = `
      <label>範囲指定する人の名前:</label><br>
      <input type="text" placeholder="例: 山田太郎" /><br>
      <button class="selectRangeBtn">範囲席を選ぶ</button>
      <button class="delete">×</button>
    `;
    rangeConditions.appendChild(div);

    const input = div.querySelector('input');
    const selectBtn = div.querySelector('.selectRangeBtn');
    const deleteBtn = div.querySelector('.delete');

    selectBtn.onclick = () => {
      const name = input.value.trim();
      if(!name) return alert('名前を入力してください');
      currentRangeName = name;
      currentRangeSelectedSeats = new Set(rangeSelections[name] || []);
      openRangeModal(name);
    };

    deleteBtn.onclick = () => {
      const name = input.value.trim();
      if(name && rangeSelections[name]) {
        delete rangeSelections[name];
      }
      div.remove();
      createMainSeats();
    };
  }

  // 固定席条件追加
  function addFixedCondition(){
    const div = document.createElement('div');
    div.className = 'condition-group';
    div.innerHTML = `
      <label>固定席にしたい人の名前:</label><br>
      <input type="text" placeholder="例: 鈴木花子" /><br>
      <button class="selectFixedBtn">固定席を選ぶ</button>
      <button class="delete">×</button>
    `;
    fixedConditions.appendChild(div);

    const input = div.querySelector('input');
    const selectBtn = div.querySelector('.selectFixedBtn');
    const deleteBtn = div.querySelector('.delete');

    selectBtn.onclick = () => {
      const name = input.value.trim();
      if(!name) return alert('名前を入力してください');
      alert(`${name}さんの固定席をメイン席表から選んでください。`);
      mode = 'fixed-selecting';
      currentRangeName = name;
    };

    deleteBtn.onclick = () => {
      const name = input.value.trim();
      if(!name){
        div.remove();
        return;
      }
      // 削除した人の固定席を消す
      for(const [seatNum, nm] of Object.entries(fixedSelections)){
        if(nm === name){
          delete fixedSelections[seatNum];
        }
      }
      div.remove();
      createMainSeats();
    };
  }

  // メイン席ダブルクリックで無効席トグル
  seatsDiv.addEventListener('dblclick', (e)=>{
    if(!e.target.classList.contains('seat')) return;
    const seatNum = Number(e.target.dataset.number);

    if(disabledSeats.has(seatNum)){
      disabledSeats.delete(seatNum);
    } else {
      disabledSeats.add(seatNum);
      if(fixedSelections[seatNum]){
        delete fixedSelections[seatNum];
      }
    }
    createMainSeats();
  });

  // メイン席クリック処理（固定席選択モード）
  seatsDiv.addEventListener('click', (e)=>{
    if(!e.target.classList.contains('seat')) return;
    const seatNum = Number(e.target.dataset.number);
    if(mode === 'fixed-selecting'){
      if(disabledSeats.has(seatNum)){
        alert('この席は無効席です');
        return;
      }
      if(fixedSelections[seatNum]){
        alert('この席はすでに固定されています');
        return;
      }
      // 同じ人の固定席あったら削除
      for(const [sn, nm] of Object.entries(fixedSelections)){
        if(nm === currentRangeName){
          delete fixedSelections[sn];
          break;
        }
      }
      fixedSelections[seatNum] = currentRangeName;
      mode = '';
      alert(`${currentRangeName}さんの固定席を${seatNum}番に設定しました。`);
      createMainSeats();
    }
  });

  // 範囲指定モーダル開く
  function openRangeModal(name){
    rangeModalTitle.textContent = `${name}さんの範囲指定席を選択してください`;
    modalSeatsDiv.innerHTML = '';
    for(let i=1; i<=36; i++){
      const seat = document.createElement('div');
      seat.className = 'seat';
      seat.textContent = i;
      seat.dataset.number = i;
      if(currentRangeSelectedSeats.has(i)){
        seat.classList.add('selected');
      }
      seat.onclick = () => {
        if(seat.classList.contains('selected')){
          seat.classList.remove('selected');
          currentRangeSelectedSeats.delete(i);
        } else {
          currentRangeSelectedSeats.add(i);
          seat.classList.add('selected');
        }
      };
      modalSeatsDiv.appendChild(seat);
    }
    rangeModal.style.display = 'flex';
  }

  // 範囲指定モーダル保存
  rangeModalSaveBtn.onclick = () => {
    if(currentRangeSelectedSeats.size === 0){
      alert('最低1席は選択してください');
      return;
    }
    rangeSelections[currentRangeName] = Array.from(currentRangeSelectedSeats).sort((a,b)=>a-b);
    rangeModal.style.display = 'none';
    currentRangeName = '';
    currentRangeSelectedSeats.clear();
    createMainSeats();
  };

  // 範囲指定モーダルキャンセル
  rangeModalCloseBtn.onclick = () => {
    rangeModal.style.display = 'none';
    currentRangeName = '';
    currentRangeSelectedSeats.clear();
  };

  // 選択リセット
  function resetSelection(){
    mode = '';
    currentRangeName = '';
    currentRangeSelectedSeats.clear();
    fixedSelections = {};
    rangeSelections = {};
    disabledSeats = new Set();
    otherNamesInput.value = '';
    createMainSeats();
    rangeConditions.innerHTML = '<h3>範囲指定（誰かをいくつかの席の中に入れる）</h3>';
    fixedConditions.innerHTML = '<h3>固定席指定（誰かをこの席に固定）</h3>';
    addRangeCondition();
    addFixedCondition();
  }

  // 配列シャッフルユーティリティ
  function shuffleArray(array) {
    const arr = array.slice();
    for(let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // 席替え実行
 function shuffleSeats(){
  // 名前重複チェック
  const allNames = new Set();
  for(const [sn, nm] of Object.entries(fixedSelections)){
    if(!disabledSeats.has(Number(sn))){
      if(allNames.has(nm)){
        alert(`重複している名前があります: ${nm}`);
        return;
      }
      allNames.add(nm);
    }
  }
  for(const name of Object.keys(rangeSelections)){
    if(allNames.has(name)){
      alert(`重複している名前があります: ${name}`);
      return;
    }
    allNames.add(name);
  }
  const others = otherNamesInput.value.trim().split('\n').map(s=>s.trim()).filter(s=>s);
  for(const name of others){
    if(allNames.has(name)){
      alert(`重複している名前があります: ${name}`);
      return;
    }
    allNames.add(name);
  }

  // seatAssign 初期化
  const seatAssign = Array(37).fill(null);
  for(const [sn, nm] of Object.entries(fixedSelections)){
    if(!disabledSeats.has(Number(sn))){
      seatAssign[Number(sn)] = nm;
    }
  }

  // 範囲指定の処理
  const rangeNames = Object.keys(rangeSelections);
  let rangeSeatsPairs = rangeNames.map(name => ({
    name,
    seats: rangeSelections[name].filter(sn => !disabledSeats.has(sn) && !seatAssign[sn])
  }));
  rangeSeatsPairs.sort((a,b) => a.seats.length - b.seats.length);

  const usedSeats = new Set(Object.keys(fixedSelections).map(Number));
  const resultAssign = {};

  function backtrack(i){
    if(i === rangeSeatsPairs.length) return true;
    const { name, seats } = rangeSeatsPairs[i];
    const candidates = shuffleArray(seats);
    for(const sn of candidates){
      if(!usedSeats.has(sn)){
        usedSeats.add(sn);
        resultAssign[name] = sn;
        if(backtrack(i+1)) return true;
        usedSeats.delete(sn);
        delete resultAssign[name];
      }
    }
    return false;
  }

  if(!backtrack(0)){
    alert('範囲指定の条件が多すぎて割り当てできません。');
    return;
  }

  // 空いてる席に others を配置
  const assignedSeats = new Set([...usedSeats, ...Object.values(resultAssign).map(Number)]);
  for(const sn of Object.keys(fixedSelections)){
    assignedSeats.add(Number(sn));
  }

  const availableSeats = [];
  for(let i=1; i<=36; i++){
    if(!disabledSeats.has(i) && !assignedSeats.has(i)){
      availableSeats.push(i);
    }
  }

  if(others.length > availableSeats.length){
    alert('空席が足りません。条件なしの人数を減らすか席を有効にしてください。');
    return;
  }

  const shuffledAvailableSeats = shuffleArray(availableSeats);

  // 最終 seatAssign に配置
  for(const [nm, sn] of Object.entries(resultAssign)){
    seatAssign[sn] = nm;
  }
  others.forEach((nm, i) => {
    seatAssign[shuffledAvailableSeats[i]] = nm;
  });

  // JSON化 → URLに載せて result.html に移動
  const seatAssignObj = {};
  for(let i=1; i<=36; i++){
    seatAssignObj[i] = seatAssign[i] || '';
  }
  const encoded = encodeURIComponent(JSON.stringify(seatAssignObj));
  window.location.href = `result.html?data=${encoded}`;
}

// ページ読み込み時の初期化
  createMainSeats();
  addRangeCondition();
  addFixedCondition();
</script>
</body>
</html>

